<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>GAMEHUB | Ultra Secure</title>
    <style>
        /* Adicione aqui o seu CSS anterior */
        :root { --accent: #8b5cf6; --bg: #070b14; }
        .security-badge { color: #10b981; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>
    <div id="gamePage" class="game-page">
        <div class="game-header">
            <span id="pgTitle">JOGO</span>
            <button onclick="closeGame()">FECHAR</button>
        </div>
        <div class="iframe-wrapper">
            <iframe src="" id="gameIframe" 
                sandbox="allow-scripts allow-same-origin allow-forms" 
                allowfullscreen></iframe>
        </div>
    </div>

    <div id="postModal" class="modal-box">
        <h2>SUBIR PROJETO <span class="security-badge">AI SCAN ACTIVE</span></h2>
        <input type="text" id="postTitle" placeholder="T√≠tulo do Jogo">
        
        <div class="file-area">
            <label for="gameFiles" class="file-upload-label">üìÅ SELECIONAR ARQUIVOS (HTML/JS/CSS)</label>
            <input type="file" id="gameFiles" accept=".html,.js,.css" multiple onchange="scanFiles(this)">
            <div id="scanStatus"></div>
        </div>

        <button class="btn-main" id="publishBtn" disabled onclick="publishProject()">PUBLICAR PROJETO</button>
    </div>

    <script src="config.js"></script>
    <script>
        let currentUser = AuthSystem.getSession();
        let safeFilesBundle = "";

        // IA de Verifica√ß√£o de Seguran√ßa (Heur√≠stica)
        async function scanFiles(input) {
            const files = input.files;
            const status = document.getElementById('scanStatus');
            const btn = document.getElementById('publishBtn');
            status.innerHTML = "üîç Escaneando arquivos...";
            
            for (let file of files) {
                const text = await file.text();
                
                // Padr√µes de Malware/XSS comuns
                const dangerousPatterns = [
                    /localStorage/gi, /sessionStorage/gi, /document\.cookie/gi,
                    /<script.*src.*http/gi, /eval\(/gi, /top\.location/gi,
                    /parent\.document/gi, /fetch\(.*http.*\.php/gi
                ];

                for (let pattern of dangerousPatterns) {
                    if (pattern.test(text)) {
                        status.innerHTML = `‚ùå ERRO: C√≥digo suspeito detectado em ${file.name}!`;
                        status.style.color = "#ef4444";
                        btn.disabled = true;
                        return;
                    }
                }
            }

            // Se for HTML/JS/CSS, vamos "empacotar" em um √∫nico Base64 seguro
            // (Para Three.js, o ideal √© subir um ZIP ou usar um bundler, mas aqui usamos o arquivo principal)
            const mainFile = Array.from(files).find(f => f.name.endsWith('.html'));
            if(mainFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    safeFilesBundle = e.target.result;
                    status.innerHTML = "‚úÖ Arquivos verificados e seguros!";
                    status.style.color = "#10b981";
                    btn.disabled = false;
                };
                reader.readAsDataURL(mainFile);
            }
        }

        async function publishProject() {
            const title = document.getElementById('postTitle').value;
            if(!title || !safeFilesBundle) return alert("Preencha tudo!");

            await db.collection("games").add({
                title: escapeHTML(title), // Sanitiza o t√≠tulo
                url: safeFilesBundle,
                author: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Sucesso!");
            location.reload();
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }

        function openGame(url, title) {
            const frame = document.getElementById('gameIframe');
            document.getElementById('pgTitle').innerText = title;
            frame.src = url;
            document.getElementById('gamePage').style.display = 'flex';
        }
    </script>
</body>
</html>
